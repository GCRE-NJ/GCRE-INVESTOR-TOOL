<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Inform browsers that both light and dark color schemes are supported -->
  <meta name="color-scheme" content="light dark" />
  <title>GCRE North NJ Rent Estimator</title>
  <!-- Inline CSS for a clean, mobile‑first layout. All values are kept here so that the
       page can live as a single file. You can tweak colors, spacing or fonts by
       editing the variables below. -->
  <style>
    :root {
      /* Apple-inspired palette: soft neutrals with a bright accent. */
      --bg: #F5F5F7;
      --card-bg: #FFFFFF;
      --primary: #007AFF;
      --border: #E5E5EA;
      --text: #1C1C1E;
      --radius: 0.75rem;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      --max-width: 1200px;
    }
    /* Dark mode variables. When the body element has the `dark` class
       these CSS variables update to darker tones. */
    body.dark {
      --bg: #1C1C1E;
      --card-bg: #2C2C2E;
      --border: #3A3A3C;
      --text: #F5F5F7;
      /* keep the primary accent the same so it pops on both themes */
    }
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
        Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    header {
      background: var(--card-bg);
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    /* Header action buttons */
    .header-btn {
      padding: 0.5rem 1rem;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      margin-left: 0.5rem;
    }
    .header-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #signin-container {
      padding: 1rem;
      text-align: right;
    }
    #user-info {
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 1rem;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem;
      flex: 1 1 100%;
    }
    @media (min-width: 900px) {
      /* In the tabbed interface we show only one card at a time, so let
         each card take the full width to avoid empty space. */
      .card.inputs,
      .card.results,
      #metricsCard,
      #rentalCard,
      #dealCard {
        flex: 1 1 100%;
      }
    }
    .card h2 {
      margin-top: 0;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
    }
    input[type="number"], select, input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 1rem;
    }
    .inline {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .inline input[type="number"] {
      flex: 1;
    }
    button.action {
      padding: 0.75rem 1rem;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      width: 100%;
      margin-top: 0.5rem;
    }
    button.action:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .info-table {
      width: 100%;
      border-collapse: collapse;
    }
    .info-table th, .info-table td {
      border: 1px solid var(--border);
      padding: 0.5rem;
      text-align: left;
    }
    .info-table th {
      /* Use card background so headers remain legible on dark backgrounds. */
      background: var(--card-bg);
      color: var(--text);
    }
    .hidden {
      display: none !important;
    }
    /* New styling for unit selection buttons */
    .units-buttons {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .unit-btn {
      flex: 1;
      padding: 0.75rem;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      text-align: center;
    }
    .unit-btn.selected {
      /* Slightly darker shade when selected */
      background: #00449e;
    }

    /* Styles for the new tab navigation. Tabs sit above the cards and
       allow the user to switch between base info, deal metrics and
       rental analysis. Disabled tabs are non-interactive until
       preconditions are met (e.g. an estimate has been generated). */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin: 0 1rem 1rem;
    }
    .tab-btn {
      flex: 1;
      padding: 0.5rem 1rem;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-bottom: 3px solid transparent;
      border-radius: var(--radius) var(--radius) 0 0;
      cursor: pointer;
      color: var(--text);
      text-align: center;
    }
    .tab-btn.active {
      border-bottom-color: var(--primary);
      font-weight: bold;
    }
    .tab-btn.disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Header styling incorporating the art deco design provided by the user */
    /* We overlay a darker gradient on the art‑deco pattern to ensure the title is readable in dark mode. */
    header {
      background-image: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), url('design.jpg');
      background-size: cover;
      background-position: center;
      color: #d4af37; /* gold tone for contrast on dark pattern */
      padding: 1rem 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    }
  </style>
  <!-- Google Identity Services. Replace YOUR_GOOGLE_CLIENT_ID with your own client id
       from the Google Cloud Console (OAuth). Without a valid client ID the sign in
       button will not function. -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <header>
    <h1>GCRE North NJ Rent Estimator</h1>
    <!-- Header action buttons: connect and dark mode toggle -->
    <button id="connectHeaderBtn" class="header-btn">Connect with GCRE</button>
    <button id="copySummary" class="header-btn" style="display:none;">Copy Summary</button>
    <button id="darkModeToggle" class="header-btn">Light mode</button>
  </header>
  <!-- Hide the Google sign-in UI since we no longer require login -->
  <div id="signin-container" style="display:none;">
    <div id="g_id_onload"
         data-client_id="YOUR_GOOGLE_CLIENT_ID"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false"></div>
    <div class="g_id_signin"
         data-type="standard"
         data-size="large"></div>
    <div id="user-info" class="hidden">
      Signed in as <strong id="user-name"></strong> (<span id="user-email"></span>)
      <button id="signout" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem;">Sign out</button>
    </div>
  </div>
  <div class="container">
    <!-- Tabs navigation -->
    <div class="tabs">
      <!-- Tab order: Base Info (inputs), Deal Metrics (investor inputs), Rental Analysis (rent results), Deal Analysis (pro-forma results). -->
      <button id="tabBase" class="tab-btn active">Base Info</button>
      <button id="tabMetrics" class="tab-btn disabled">Deal Metrics</button>
      <button id="tabRental" class="tab-btn disabled">Rental Analysis</button>
      <button id="tabDeal" class="tab-btn disabled">Deal Analysis</button>
    </div>
    <!-- Input card for base info -->
    <div class="card inputs" id="inputsCard">
      <h2>Base Info</h2>
      <label for="county">County</label>
      <!-- County selector populated from the rents JSON. When a county is selected,
           the towns dropdown will update accordingly. -->
      <select id="county">
        <option value="">Select county</option>
      </select>
      <label for="town">Town</label>
      <!-- Town selector populated based on the selected county. -->
      <select id="town" disabled>
        <option value="">Select town</option>
      </select>
      <!-- Style has been removed in favour of inferring it from the number of units. 1 unit
           is treated as a single‑family home; 2–4 units map to 2‑, 3‑ and 4‑family. -->
      <label for="units">Number of Units</label>
      <!-- Hidden input storing the numeric units value. This is updated when
           the user clicks one of the unit buttons below. -->
      <input type="hidden" id="units" value="1" />
      <!-- Unit selection buttons. Users can quickly choose single family
           or multi‑family units by clicking these. The selected button
           is highlighted via the "selected" class. -->
      <div id="unitsButtons" class="units-buttons">
        <button type="button" class="unit-btn selected" data-units="1">Single Family</button>
        <button type="button" class="unit-btn" data-units="2">2 Units</button>
        <button type="button" class="unit-btn" data-units="3">3 Units</button>
        <button type="button" class="unit-btn" data-units="4">4 Units</button>
      </div>
      <label for="beds">Bedrooms per Unit</label>
      <input type="number" id="beds" min="0" max="10" value="2" />
      <label for="baths">Bathrooms per Unit</label>
      <input type="number" id="baths" min="0" max="10" value="1" />
      <!-- Collapsible optional fields. These details are not required for a basic estimate
           and are hidden by default. Clicking the button below toggles the section. -->
      <button type="button" id="toggleOptional" class="action">Show Optional Fields</button>
      <div id="optionalFields" class="hidden">
        <label for="sqft">Square Footage (optional)</label>
        <input type="number" id="sqft" min="0" value="" placeholder="e.g. 1200" />
        <label for="wd">Washer/Dryer</label>
        <select id="wd">
          <option value="none">None</option>
          <option value="shared">Shared</option>
          <option value="in-unit">In-unit</option>
        </select>
        <label for="parking">Parking</label>
        <select id="parking">
          <option value="none">None</option>
          <option value="street">Street</option>
          <option value="driveway">Driveway</option>
          <option value="garage">Garage</option>
        </select>
        <label for="utilities">Utilities Responsibility</label>
        <select id="utilities">
          <option value="tenant">Tenant pays all</option>
          <option value="split">Split</option>
          <option value="ll">LL pays all</option>
        </select>
        <label for="renovation">Renovation</label>
        <select id="renovation">
          <option value="6+ years">6+ years</option>
          <option value="refresh 5 years">Refresh (≤5 years)</option>
          <option value="refresh 3 years">Refresh (≤3 years)</option>
          <option value="gut renovation">Gut renovation (≤3 years)</option>
          <option value="new construction">New construction</option>
        </select>
        <label for="pets">Pets Allowed</label>
        <select id="pets">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
        <label for="backyard">Backyard</label>
        <select id="backyard">
          <option value="none">None</option>
          <option value="shared">Shared</option>
          <option value="private">Private</option>
        </select>
        <label for="transit">Near Transit</label>
        <select id="transit">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
        <label for="basement">Finished Basement/Attic</label>
        <select id="basement">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
      </div>
      <!-- Button to generate a rental analysis. Clicking this will compute the baseline
           rent and enable the other tabs. -->
      <button id="analysisBtn" class="action">Generate Rental Analysis</button>
    </div>

    <!-- Metrics card: contains the investor field inputs and calculation button -->
    <div class="card hidden" id="metricsCard">
      <h2>Deal Metrics</h2>
      <label for="price">Purchase Price (optional)</label>
      <input type="number" id="price" min="0" step="1000" />
      <label for="taxes">Taxes (annual, optional)</label>
      <input type="number" id="taxes" min="0" step="10" />
      <label for="insurance">Insurance (annual, optional)</label>
      <input type="number" id="insurance" min="0" step="10" />
      <label for="hoa">HOA Fee (monthly, optional)</label>
      <input type="number" id="hoa" min="0" step="10" />
      <div class="inline">
        <label for="vacancy" style="flex: 1;">Vacancy&nbsp;%</label>
        <input type="number" id="vacancy" min="0" max="100" step="0.5" value="5" style="width: 5rem;" />
      </div>
      <div class="inline">
        <label for="maintenance" style="flex: 1;">Maintenance&nbsp;%</label>
        <input type="number" id="maintenance" min="0" max="100" step="0.5" value="5" style="width: 5rem;" />
      </div>
      <div class="inline">
        <label for="management" style="flex: 1;">Management&nbsp;%</label>
        <input type="number" id="management" min="0" max="100" step="0.5" value="5" style="width: 5rem;" />
      </div>
      <label style="margin-top:0.5rem;">ROI Target</label>
      <div id="roiOptions" style="margin-bottom:0.5rem;">
        <label style="margin-right:0.5rem;"><input type="radio" name="roiLevel" value="conservative" checked> Conservative</label>
        <label style="margin-right:0.5rem;"><input type="radio" name="roiLevel" value="target"> Target</label>
        <label><input type="radio" name="roiLevel" value="aggressive"> Aggressive</label>
        <span id="roiDisclaimer" class="hidden" style="display:block;margin-top:0.25rem;font-size:0.8rem;color:var(--text);">Vacancy may be higher with aggressive ROI targets.</span>
      </div>
      <!-- Button to calculate deal analysis. After a rental analysis has been generated,
           clicking this button will compute the pro‑forma numbers and show the Deal
           Analysis tab. -->
      <button id="metricsBtn" class="action">Generate Deal Analysis</button>
    </div>
    <!-- Rental analysis card: displays the baseline and adjusted rents. This card
         appears only after the user generates a rental analysis. -->
    <div class="card results hidden" id="rentalCard">
      <h2>Rental Analysis</h2>
      <div id="rentalResults"></div>
    </div>
    <!-- Deal analysis card: displays the pro-forma metrics such as NOI and cap rate.
         It becomes visible only after the user calculates deal metrics. -->
    <div class="card results hidden" id="dealCard">
      <h2>Investment Metrics</h2>
      <div id="dealResults"></div>
    </div>
    <!-- Connect card -->
    <!-- This call to action invites the user to connect with the GCRE team. Rather than
         scheduling a consultation, the user enters their email and clicks
         connect. This opens their mail client with a message to galncohen@gmail.com. -->
    <div class="card results hidden" id="connectCard">
      <h2>Connect with GCRE</h2>
      <p>Enter your email below and click Connect to reach out to our team.</p>
      <label for="connectEmail">Your Email</label>
      <input type="email" id="connectEmail" placeholder="you@example.com" />
      <button id="connectBtn" class="action">Connect</button>
      <p id="connectMessage" class="note" style="margin-top:0.5rem;"></p>
    </div>
    <!-- Saved analyses card -->
    <div class="card results hidden" id="savedCard">
      <h2>Saved Analyses</h2>
      <div id="analysisList"></div>
    </div>
  </div>
  <script>
    // Configuration object containing baseline adjustments. You can tune these values
    // without changing the logic below. The ranges reflect typical rents in the
    // North NJ area; adjust accordingly based on market research.
    const CONFIG = {
      adjustment: {
        wd: { 'none': 0, 'shared': 35, 'in-unit': 100 },
        parking: { 'none': 0, 'street': 0, 'driveway': 75, 'garage': 175 },
        utilities: { 'tenant': 0, 'split': 75, 'll': 200 },
        renovation: {
          '6+ years': 0,
          'refresh 5 years': 0.02,
          'refresh 3 years': 0.05,
          'gut renovation': 0.09,
          'new construction': 0.12
        },
        pets: { 'no': 0, 'yes': 35 },
        backyard: { 'none': 0, 'shared': 40, 'private': 100 },
        transit: { 'no': 0, 'yes': 75 },
        basement: { 'no': 0, 'yes': 75 }
      },
      band: { low: 0.95, high: 1.08 }
    };

    // Comprehensive list of Bergen County municipalities. If a town appears in this list
    // but not in the rents JSON the estimator will fall back to county‑level or averaged
    // baseline rents.
    const BERGEN_TOWNS = [
      "Allendale", "Alpine", "Bergenfield", "Bogota", "Carlstadt", "Cliffside Park",
      "Closter", "Cresskill", "Demarest", "Dumont", "East Rutherford", "Edgewater",
      "Elmwood Park", "Emerson", "Englewood", "Englewood Cliffs", "Fair Lawn",
      "Fairview", "Fort Lee", "Franklin Lakes", "Garfield", "Glen Rock",
      "Hackensack", "Harrington Park", "Hasbrouck Heights", "Haworth", "Hillsdale",
      "Ho Ho Kus", "Leonia", "Little Ferry", "Lodi", "Lyndhurst", "Mahwah",
      "Maywood", "Midland Park", "Montvale", "Moonachie", "New Milford",
      "North Arlington", "Northvale", "Norwood", "Oakland", "Old Tappan",
      "Oradell", "Palisades Park", "Paramus", "Park Ridge", "Ramsey",
      "Ridgefield", "Ridgefield Park", "Ridgewood", "River Edge", "River Vale",
      "Rochelle Park", "Rockleigh", "Rutherford", "Saddle Brook", "Saddle River",
      "South Hackensack", "Teaneck", "Tenafly", "Teterboro", "Upper Saddle River",
      "Waldwick", "Wallington", "Washington Township", "Westwood", "Wood-Ridge",
      "Woodcliff Lake", "Wyckoff"
    ];

    // Comprehensive list of Essex County municipalities. This ensures that
    // towns like Nutley and others absent from the original rents JSON
    // still appear in the dropdown when Essex is selected.
    const ESSEX_TOWNS = [
      "Belleville", "Bloomfield", "Caldwell", "Cedar Grove", "East Orange",
      "Essex Fells", "Fairfield", "Glen Ridge", "Irvington", "Livingston",
      "Maplewood", "Millburn", "Montclair", "Newark", "North Caldwell",
      "Nutley", "Orange", "Roseland", "South Orange", "Verona",
      "West Caldwell", "West Orange"
    ];

    // Comprehensive list of Hudson County municipalities. This includes
    // all 12 municipalities within Hudson County.
    const HUDSON_TOWNS = [
      "Bayonne", "East Newark", "Guttenberg", "Harrison", "Hoboken",
      "Jersey City", "Kearny", "North Bergen", "Secaucus", "Union City",
      "Weehawken", "West New York"
    ];

    // Comprehensive list of Passaic County municipalities. All 16
    // municipalities in Passaic County are represented here.
    const PASSAIC_TOWNS = [
      "Bloomingdale", "Clifton", "Haledon", "Hawthorne", "Little Falls",
      "North Haledon", "Passaic", "Paterson", "Pompton Lakes",
      "Prospect Park", "Ringwood", "Totowa", "Wanaque", "Wayne",
      "West Milford", "Woodland Park"
    ];

    // Data loaded from external rents file (county‑level baselines)
    let rentsData = {};
    // Data derived from NJMLS listings. This maps each town directly to
    // median rents by style and bedroom count. It is loaded once the page
    // initializes and used as the primary baseline when available.
    let mlsData = {};
    // Current user info
    let currentUser = null;

    // Populate county and town selectors once data is loaded
    async function loadRents() {
      try {
        const response = await fetch('data/rents-north-nj.json');
        rentsData = await response.json();
        // Load the MLS‑derived baselines. If the fetch fails for any reason
        // (for example the file is missing), the tool will continue using
        // only the county‑level baselines.
        try {
          const mlsResp = await fetch('data/rents-njmls.json');
          if (mlsResp.ok) {
            mlsData = await mlsResp.json();
          }
        } catch (e) {
          console.warn('Unable to load MLS data; falling back to county baselines', e);
        }
        // Populate county options
        const countySelect = document.getElementById('county');
        countySelect.innerHTML = '<option value="">Select county</option>';
        Object.keys(rentsData).sort().forEach(countyName => {
          const opt = document.createElement('option');
          opt.value = countyName;
          opt.textContent = countyName;
          countySelect.appendChild(opt);
        });
        // Add change listener to update towns when county changes
        countySelect.addEventListener('change', updateTowns);
      } catch (err) {
        console.error('Failed to load rents data', err);
      }
    }

    // Update the towns dropdown based on selected county
    function updateTowns() {
      const countyName = document.getElementById('county').value;
      const townSelect = document.getElementById('town');
      townSelect.innerHTML = '';
      if (!countyName || !rentsData[countyName]) {
        // Disable the town selector when no county selected
        townSelect.disabled = true;
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Select town';
        townSelect.appendChild(opt);
        return;
      }
      // Determine the list of towns for the selected county. Use comprehensive
      // county lists for Bergen, Essex, Hudson and Passaic so that towns
      // absent from the original rents JSON still appear (e.g., Nutley in Essex).
      let towns;
      if (countyName === 'Bergen') {
        towns = BERGEN_TOWNS.slice();
      } else if (countyName === 'Essex') {
        towns = ESSEX_TOWNS.slice();
      } else if (countyName === 'Hudson') {
        towns = HUDSON_TOWNS.slice();
      } else if (countyName === 'Passaic') {
        towns = PASSAIC_TOWNS.slice();
      } else {
        towns = Object.keys(rentsData[countyName] || {});
      }
      // Populate town options
      townSelect.disabled = false;
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Select town';
      townSelect.appendChild(placeholder);
      towns.sort().forEach(town => {
        const opt = document.createElement('option');
        opt.value = town;
        opt.textContent = town;
        townSelect.appendChild(opt);
      });
    }

    // Helper to find baseline rent by town, beds and style
    function findBaseline(town, beds, style) {
      // First look in the MLS‑derived dataset. This provides median
      // rents for each town without requiring a county selection. The keys
      // are town names; within each town, style and bedroom count keys
      // exist if there were sufficient listings. Because bedrooms are stored
      // as numbers in the JSON, convert the beds argument to string when
      // looking up. If no direct match is found, fall back to the county
      // baselines loaded from rentsData.
      const b = beds;
      if (mlsData && mlsData[town] && mlsData[town][style] && mlsData[town][style][b]) {
        return { rent: mlsData[town][style][b], source: `${town}, ${beds}br, ${style} (MLS)` };
      }
      // Fallback to county‑level baselines as before
      for (const countyName in rentsData) {
        const county = rentsData[countyName];
        if (county[town]) {
          const byBed = county[town];
          if (byBed[beds] && byBed[beds][style]) {
            return { rent: byBed[beds][style], source: `${town}, ${beds}br, ${style}` };
          }
          if (byBed[beds]) {
            const styles = byBed[beds];
            const firstStyle = Object.keys(styles)[0];
            return { rent: styles[firstStyle], source: `${town}, ${beds}br` };
          }
          // Nearest bed for this town
          const bedKeys = Object.keys(byBed).sort((a, b) => Math.abs(a - beds) - Math.abs(b - beds));
          for (const k of bedKeys) {
            const styles = byBed[k];
            const firstStyle = Object.keys(styles)[0];
            return { rent: styles[firstStyle], source: `${town}, ${k}br (nearest)` };
          }
        }
        // Fallback to county level
        const byBedCounty = county[beds];
        if (byBedCounty && byBedCounty[style]) {
          return { rent: byBedCounty[style], source: `${countyName} county, ${beds}br, ${style}` };
        }
        if (byBedCounty) {
          const firstStyle = Object.keys(byBedCounty)[0];
          return { rent: byBedCounty[firstStyle], source: `${countyName} county, ${beds}br` };
        }
        // nearest bed at county level
        const bedKeysCounty = Object.keys(county).filter(k => !isNaN(Number(k))).sort((a, b) => Math.abs(a - beds) - Math.abs(b - beds));
        for (const k of bedKeysCounty) {
          const styles = county[k];
          const firstStyle = Object.keys(styles)[0];
          return { rent: styles[firstStyle], source: `${countyName} county, ${k}br (nearest)` };
        }
      }
      // As a last resort, compute the average rent across all towns for the requested
      // bedroom count and style. If the exact style is not available, we take the
      // first available style for each town. This maintains backwards compatibility
      // with the previous logic.
      let total = 0;
      let count = 0;
      for (const countyName in rentsData) {
        const county = rentsData[countyName];
        for (const t in county) {
          const byBed = county[t];
          if (byBed[beds] && byBed[beds][style]) {
            total += byBed[beds][style];
            count++;
          } else if (byBed[beds]) {
            const anyStyle = Object.values(byBed[beds])[0];
            total += anyStyle;
            count++;
          }
        }
      }
      if (count > 0) {
        const avg = total / count;
        return { rent: avg, source: 'Average across available data' };
      }
      return { rent: 0, source: 'No data' };
    }

    // Apply adjustments to a base rent given selected options
    function applyAdjustments(baseRent, opts) {
      let adjusted = baseRent;
      const breakdown = [];
      // Add absolute adjustments
      ['wd', 'parking', 'utilities', 'pets', 'backyard', 'transit', 'basement'].forEach(key => {
        const addValue = CONFIG.adjustment[key][opts[key]] || 0;
        if (addValue !== 0) {
          breakdown.push(`${key} +$${addValue}`);
        }
        adjusted += addValue;
      });
      // Percentage adjustment
      const perc = CONFIG.adjustment.renovation[opts.renovation] || 0;
      if (perc !== 0) {
        breakdown.push(`renovation +${(perc * 100).toFixed(0)}%`);
        adjusted *= (1 + perc);
      }
      return { adjusted, breakdown };
    }

    // Compute pro-forma numbers based on rents and expenses
    function computeProForma(totalRent, investor) {
      // Convert annual taxes and insurance into monthly values
      const taxesMonthly = (investor.taxes || 0) / 12;
      const insuranceMonthly = (investor.insurance || 0) / 12;
      const hoaMonthly = investor.hoa || 0;
      const vacancyLoss = totalRent * (investor.vacancy / 100);
      const maintenance = totalRent * (investor.maintenance / 100);
      const management = totalRent * (investor.management / 100);
      // Expenses include monthly taxes/insurance, HOA, maintenance, management and vacancy loss
      const expenses = taxesMonthly + insuranceMonthly + hoaMonthly + maintenance + management + vacancyLoss;
      const noi = totalRent - expenses;
      let cap = null;
      if (investor.price && investor.price > 0) {
        cap = (noi * 12) / investor.price;
      }
      return { taxesMonthly, insuranceMonthly, hoaMonthly, vacancyLoss, maintenance, management, expenses, noi, cap };
    }

    // Tab management functions. These functions show or hide cards depending on
    // which tab is selected. They also update the active state on the tab buttons.
    function showBaseTab() {
      // Highlight the Base Info tab and show only the inputs card. Hide all
      // result and investor cards. Reset connect message.
      const tabs = ['tabBase','tabMetrics','tabRental','tabDeal'];
      tabs.forEach(id => document.getElementById(id).classList.remove('active'));
      document.getElementById('tabBase').classList.add('active');
      document.getElementById('inputsCard').classList.remove('hidden');
      document.getElementById('metricsCard').classList.add('hidden');
      document.getElementById('rentalCard').classList.add('hidden');
      document.getElementById('dealCard').classList.add('hidden');
      document.getElementById('connectCard').classList.add('hidden');
    }

    function showRentalTab() {
      // Highlight the Rental Analysis tab and display the rental results card. Hide others.
      const tabs = ['tabBase','tabMetrics','tabRental','tabDeal'];
      tabs.forEach(id => document.getElementById(id).classList.remove('active'));
      document.getElementById('tabRental').classList.add('active');
      document.getElementById('inputsCard').classList.add('hidden');
      document.getElementById('metricsCard').classList.add('hidden');
      document.getElementById('rentalCard').classList.remove('hidden');
      document.getElementById('dealCard').classList.add('hidden');
      document.getElementById('connectCard').classList.add('hidden');
    }

    function showMetricsTab() {
      // Highlight the Deal Metrics tab and display the investor input card. Hide result cards.
      const tabs = ['tabBase','tabMetrics','tabRental','tabDeal'];
      tabs.forEach(id => document.getElementById(id).classList.remove('active'));
      document.getElementById('tabMetrics').classList.add('active');
      document.getElementById('inputsCard').classList.add('hidden');
      document.getElementById('metricsCard').classList.remove('hidden');
      document.getElementById('rentalCard').classList.add('hidden');
      document.getElementById('dealCard').classList.add('hidden');
      // Hide connect card until results
      document.getElementById('connectCard').classList.add('hidden');
    }

    function showDealTab() {
      // Highlight the Deal Analysis tab and display the deal results card along with connect card.
      const tabs = ['tabBase','tabMetrics','tabRental','tabDeal'];
      tabs.forEach(id => document.getElementById(id).classList.remove('active'));
      document.getElementById('tabDeal').classList.add('active');
      document.getElementById('inputsCard').classList.add('hidden');
      document.getElementById('metricsCard').classList.add('hidden');
      document.getElementById('rentalCard').classList.add('hidden');
      document.getElementById('dealCard').classList.remove('hidden');
      document.getElementById('connectCard').classList.remove('hidden');
    }

    function enableTabsAfterRental() {
      // After generating a rental analysis, allow access to Rental Analysis and Deal Metrics tabs.
      document.getElementById('tabMetrics').classList.remove('disabled');
      document.getElementById('tabRental').classList.remove('disabled');
    }

    function enableDealTab() {
      // After generating the deal analysis, enable the Deal Analysis tab.
      document.getElementById('tabDeal').classList.remove('disabled');
    }

    // Initialise the unit selection buttons. When a button is clicked,
    // update the hidden units input and highlight the selected button.
    function setupUnitButtons() {
      const unitsInput = document.getElementById('units');
      const buttons = document.querySelectorAll('#unitsButtons .unit-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          buttons.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          unitsInput.value = btn.getAttribute('data-units');
        });
      });
    }

    // Handle estimation click
    function estimateRent() {
      const county = document.getElementById('county').value;
      const town = document.getElementById('town').value.trim();
      // derive style from number of units: 1 unit is single‑family, otherwise N‑family
      const units = parseInt(document.getElementById('units').value) || 1;
      const style = units > 1 ? `${units}-Family` : 'Single-Family';
      const beds = parseInt(document.getElementById('beds').value) || 0;
      const baths = parseInt(document.getElementById('baths').value) || 0;
      const sqft = parseInt(document.getElementById('sqft').value) || 0;
      const wd = document.getElementById('wd').value;
      const parking = document.getElementById('parking').value;
      const utilities = document.getElementById('utilities').value;
      const renovation = document.getElementById('renovation').value;
      const pets = document.getElementById('pets').value;
      const backyard = document.getElementById('backyard').value;
      const transit = document.getElementById('transit').value;
      const basement = document.getElementById('basement').value;
      // Investor fields
      const price = parseFloat(document.getElementById('price').value) || 0;
      const taxes = parseFloat(document.getElementById('taxes').value) || 0;
      const insurance = parseFloat(document.getElementById('insurance').value) || 0;
      const hoa = parseFloat(document.getElementById('hoa').value) || 0;
      const vacancy = parseFloat(document.getElementById('vacancy').value) || 0;
      const maintenance = parseFloat(document.getElementById('maintenance').value) || 0;
      const management = parseFloat(document.getElementById('management').value) || 0;
      if (!county || !town || !beds) {
        alert('Please select a county, town and number of bedrooms.');
        return;
      }
      const { rent: baseRent, source } = findBaseline(town, beds, style);
      if (baseRent === 0) {
        alert('No baseline rent found for the selected inputs.');
        return;
      }
      const opts = { wd, parking, utilities, renovation, pets, backyard, transit, basement };
      // Apply adjustments to the baseline rent. Cap the adjusted rent to
      // a maximum of 15% above the baseline to prevent excessive impact.
      let { adjusted, breakdown } = applyAdjustments(baseRent, opts);
      const maxAdjusted = baseRent * 1.15;
      if (adjusted > maxAdjusted) {
        adjusted = maxAdjusted;
        breakdown.push('capped at 15% increase');
      }
      const low = adjusted * CONFIG.band.low;
      const high = adjusted * CONFIG.band.high;
      const resultsEl = document.getElementById('rentalResults');
      const unitSummary = `<p><strong>Baseline rent:</strong> $${baseRent.toFixed(0)} (${source})</p>
        <p><strong>Adjustments:</strong> ${breakdown.length ? breakdown.join(', ') : 'none'}</p>
        <p><strong>Adjusted rent per unit:</strong> $${adjusted.toFixed(0)}</p>
        <p><strong>Rent range (low/base/high):</strong> $${low.toFixed(0)} / $${adjusted.toFixed(0)} / $${high.toFixed(0)}</p>`;
      // Total for multi-unit
      const totalRent = adjusted * units;
      const totalLow = low * units;
      const totalHigh = high * units;
      const totalSummary = units > 1 ? `<p><strong>Total (for ${units} units):</strong> $${totalLow.toFixed(0)} / $${totalRent.toFixed(0)} / $${totalHigh.toFixed(0)}</p>` : '';
      resultsEl.innerHTML = unitSummary + totalSummary;
      // Store total rent globally so the metrics tab can compute pro‑forma later.
      window.lastTotalRent = totalRent;
      window.lastVacancy = vacancy;
      window.lastMaintenance = maintenance;
      window.lastManagement = management;
      window.lastTaxes = taxes;
      window.lastInsurance = insurance;
      window.lastHoa = hoa;
      // Show only the estimate card on analysis tab. Do not compute pro‑forma here.
      document.getElementById('rentalCard').classList.remove('hidden');
      document.getElementById('dealCard').classList.add('hidden');
      document.getElementById('connectCard').classList.add('hidden');
      resultsEl.scrollIntoView({ behavior: 'smooth' });
      // Activate copy summary
      document.getElementById('copySummary').disabled = false;
      // Persist current analysis summary for copying
      window.currentAnalysis = {
        town, style, units, beds, baths, sqft, opts, baseRent, adjusted, low, high, totalRent, totalLow, totalHigh, breakdown
      };
    }

    // Copy summary to clipboard
    function copySummary() {
      if (!window.currentAnalysis) return;
      const { town, style, units, beds, baths, sqft, opts, baseRent, adjusted, low, high, totalRent, totalLow, totalHigh, pro, breakdown } = window.currentAnalysis;
      let summary = `Rent analysis for ${units} x ${beds}br/${baths}ba ${style} in ${town}\n`;
      summary += `Baseline rent: $${baseRent.toFixed(0)}\n`;
      if (breakdown.length) summary += `Adjustments: ${breakdown.join(', ')}\n`;
      summary += `Adjusted per‑unit rent: $${adjusted.toFixed(0)}\n`;
      summary += `Rent range (low/base/high): $${low.toFixed(0)} / $${adjusted.toFixed(0)} / $${high.toFixed(0)}\n`;
      if (units > 1) summary += `Total rent (for ${units} units): $${totalLow.toFixed(0)} / $${totalRent.toFixed(0)} / $${totalHigh.toFixed(0)}\n`;
      summary += `Gross monthly rent: $${totalRent.toFixed(0)}\n`;
      // If metrics have been computed, include NOI and cap rate
      const metrics = window.currentMetrics;
      if (metrics) {
        summary += `NOI: $${metrics.noi.toFixed(0)}\n`;
        if (metrics.cap !== null) summary += `Cap rate: ${(metrics.cap * 100).toFixed(2)}%\n`;
      }
      navigator.clipboard.writeText(summary).then(() => {
        alert('Summary copied to clipboard!');
      });
    }

    // Save analysis to localStorage keyed by user email
    function saveAnalysis() {
      if (!currentUser || !window.currentAnalysis) return;
      const key = 'analyses_' + currentUser.email;
      const existing = JSON.parse(localStorage.getItem(key) || '[]');
      const entry = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        summary: window.currentAnalysis
      };
      existing.push(entry);
      localStorage.setItem(key, JSON.stringify(existing));
      loadSavedAnalyses();
      alert('Analysis saved!');
    }

    // Load saved analyses from localStorage for current user
    function loadSavedAnalyses() {
      if (!currentUser) return;
      const key = 'analyses_' + currentUser.email;
      const list = JSON.parse(localStorage.getItem(key) || '[]');
      const container = document.getElementById('analysisList');
      if (!list.length) {
        container.innerHTML = '<p>No saved analyses yet.</p>';
        document.getElementById('savedCard').classList.remove('hidden');
        return;
      }
      const frag = document.createDocumentFragment();
      list.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
      list.forEach(item => {
        const div = document.createElement('div');
        const date = new Date(item.timestamp).toLocaleString();
        div.style.borderBottom = '1px solid var(--border)';
        div.style.padding = '0.5rem 0';
        const title = `${item.summary.units}×${item.summary.beds}br/${item.summary.baths}ba ${item.summary.style} in ${item.summary.town}`;
        div.innerHTML = `<strong>${title}</strong> – ${date}<br />Rent range: $${item.summary.totalLow.toFixed(0)} / $${item.summary.totalRent.toFixed(0)} / $${item.summary.totalHigh.toFixed(0)}`;
        frag.appendChild(div);
      });
      container.innerHTML = '';
      container.appendChild(frag);
      document.getElementById('savedCard').classList.remove('hidden');
    }

    // Google sign in callback
    function handleCredentialResponse(response) {
      // Decode credential (JWT) to extract user info. This does not verify the token; for a production
      // site you should send it to your backend to verify. Here we simply decode the payload.
      const decodeJwt = token => {
        const payload = token.split('.')[1];
        const json = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
        return JSON.parse(decodeURIComponent(escape(json)));
      };
      const payload = decodeJwt(response.credential);
      currentUser = { name: payload.name, email: payload.email, picture: payload.picture };
      document.getElementById('user-name').textContent = currentUser.name;
      document.getElementById('user-email').textContent = currentUser.email;
      document.getElementById('user-info').classList.remove('hidden');
      document.querySelector('.g_id_signin').classList.add('hidden');
      loadSavedAnalyses();
    }

    // Sign out function
    function signOut() {
      currentUser = null;
      document.getElementById('user-info').classList.add('hidden');
      document.querySelector('.g_id_signin').classList.remove('hidden');
      document.getElementById('savedCard').classList.add('hidden');
    }

    // Event listeners
    window.addEventListener('DOMContentLoaded', () => {
      loadRents();
      // Initialise dark mode from saved preference. Update button text accordingly.
      const darkBtn = document.getElementById('darkModeToggle');
      const savedDark = localStorage.getItem('darkMode');
      // Default to dark mode unless the user has explicitly chosen light mode.
      if (savedDark === 'false') {
        document.body.classList.remove('dark');
        darkBtn.textContent = 'Dark mode';
      } else {
        document.body.classList.add('dark');
        darkBtn.textContent = 'Light mode';
      }
      darkBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        const isDark = document.body.classList.contains('dark');
        darkBtn.textContent = isDark ? 'Light mode' : 'Dark mode';
        localStorage.setItem('darkMode', isDark);
      });

      // Header connect button: open the user's mail client to contact GCRE.
      const connectHeaderBtn = document.getElementById('connectHeaderBtn');
      if (connectHeaderBtn) {
        connectHeaderBtn.addEventListener('click', () => {
          const subject = encodeURIComponent('Rental Tool Inquiry');
          const body = encodeURIComponent('Hello GCRE,\n\nI would like to connect regarding the rental analysis tool.');
          window.location.href = `mailto:galncohen@gmail.com?subject=${subject}&body=${body}`;
        });
      }
      // Optional field toggle
      const optBtn = document.getElementById('toggleOptional');
      const optFields = document.getElementById('optionalFields');
      optBtn.addEventListener('click', () => {
        optFields.classList.toggle('hidden');
        optBtn.textContent = optFields.classList.contains('hidden') ? 'Show Optional Fields' : 'Hide Optional Fields';
      });
      // Tab buttons: switch between the four tabs. The metrics and analysis tabs
      // remain disabled until prerequisites are met.
      const tabBase = document.getElementById('tabBase');
      const tabMetricsBtn = document.getElementById('tabMetrics');
      const tabRentalBtn = document.getElementById('tabRental');
      const tabDealBtn = document.getElementById('tabDeal');
      tabBase.addEventListener('click', showBaseTab);
      tabMetricsBtn.addEventListener('click', showMetricsTab);
      tabRentalBtn.addEventListener('click', showRentalTab);
      tabDealBtn.addEventListener('click', showDealTab);

      // Hook up the action buttons for analysis and deal analysis
      const analysisBtn = document.getElementById('analysisBtn');
      if (analysisBtn) {
        analysisBtn.addEventListener('click', () => {
          estimateRent();
          // Enable Rental Analysis and Deal Metrics tabs and jump to Rental tab
          enableTabsAfterRental();
          showRentalTab();
        });
      }
      const metricsBtn = document.getElementById('metricsBtn');
      if (metricsBtn) {
        metricsBtn.addEventListener('click', () => {
          // Ensure we have a previously computed total rent
          const totalRent = window.lastTotalRent || 0;
          if (!totalRent) {
            alert('Please generate a rental analysis first.');
            return;
          }
          // Gather investor inputs
          const price = parseFloat(document.getElementById('price').value) || 0;
          const taxesVal = parseFloat(document.getElementById('taxes').value) || 0;
          const insuranceVal = parseFloat(document.getElementById('insurance').value) || 0;
          const hoaVal = parseFloat(document.getElementById('hoa').value) || 0;
          const vacancyVal = parseFloat(document.getElementById('vacancy').value) || 0;
          const maintenanceVal = parseFloat(document.getElementById('maintenance').value) || 0;
          const managementVal = parseFloat(document.getElementById('management').value) || 0;
          const investor = { price: price, taxes: taxesVal, insurance: insuranceVal, hoa: hoaVal, vacancy: vacancyVal, maintenance: maintenanceVal, management: managementVal };
          const pro = computeProForma(totalRent, investor);
          let proHTML = '<table class="info-table">';
          proHTML += `<tr><th>Gross monthly rent</th><td>$${totalRent.toFixed(0)}</td></tr>`;
          proHTML += `<tr><th>Vacancy loss (${vacancyVal}% )</th><td> -$${pro.vacancyLoss.toFixed(0)}</td></tr>`;
          proHTML += `<tr><th>Maintenance (${maintenanceVal}% )</th><td> -$${pro.maintenance.toFixed(0)}</td></tr>`;
          proHTML += `<tr><th>Management (${managementVal}% )</th><td> -$${pro.management.toFixed(0)}</td></tr>`;
          if (taxesVal) proHTML += `<tr><th>Taxes (monthly)</th><td> -$${pro.taxesMonthly.toFixed(0)}</td></tr>`;
          if (insuranceVal) proHTML += `<tr><th>Insurance (monthly)</th><td> -$${pro.insuranceMonthly.toFixed(0)}</td></tr>`;
          if (hoaVal) proHTML += `<tr><th>HOA (monthly)</th><td> -$${pro.hoaMonthly.toFixed(0)}</td></tr>`;
          proHTML += `<tr><th><strong>Net Operating Income</strong></th><td><strong>$${pro.noi.toFixed(0)}</strong></td></tr>`;
          proHTML += `<tr><th><strong>Cash flow (monthly)</strong></th><td><strong>$${pro.noi.toFixed(0)}</strong></td></tr>`;
          if (pro.cap !== null) {
            proHTML += `<tr><th><strong>Cap rate</strong></th><td><strong>${(pro.cap * 100).toFixed(2)}%</strong></td></tr>`;
          }
          proHTML += '</table>';
          document.getElementById('dealResults').innerHTML = proHTML;
          // Store metrics globally for copy summary
          window.currentMetrics = pro;
          // Show the deal analysis card and connect card
          document.getElementById('dealCard').classList.remove('hidden');
          document.getElementById('connectCard').classList.remove('hidden');
          // Enable the Deal Analysis tab and switch to it
          enableDealTab();
          showDealTab();
        });
      }
      document.getElementById('copySummary').addEventListener('click', copySummary);
      // Save analysis and sign out handlers are no longer attached because
      // the login feature has been removed.  We leave the functions defined
      // for potential future use but do not register listeners.

      // ROI disclaimer toggling: when the aggressive ROI option is selected
      // display a disclaimer about higher vacancy. Hide it otherwise.
      const roiRadios = document.querySelectorAll('input[name="roiLevel"]');
      const roiDisclaimer = document.getElementById('roiDisclaimer');
      roiRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (radio.value === 'aggressive' && radio.checked) {
            roiDisclaimer.classList.remove('hidden');
          } else {
            roiDisclaimer.classList.add('hidden');
          }
        });
      });
      // Connect form submission: handled below
      const connectBtn = document.getElementById('connectBtn');
      if (connectBtn) {
        connectBtn.addEventListener('click', () => {
          const email = document.getElementById('connectEmail').value.trim();
          const msgEl = document.getElementById('connectMessage');
          if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            msgEl.textContent = 'Please enter a valid email address.';
            return;
          }
          const subject = encodeURIComponent('Rental Tool Inquiry');
          const body = encodeURIComponent('From: ' + email + '\n\nI would like to connect with GCRE about the rental analysis tool.');
          window.location.href = `mailto:galncohen@gmail.com?subject=${subject}&body=${body}`;
        });
      }

      // Set up unit buttons after the DOM has loaded
      setupUnitButtons();
    });
  </script>
</body>
</html>